generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Role {
  id          String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name        String   @unique @map("name") @db.VarChar(50)
  permissions String?  @map("permissions") @db.Text // JSON list quyền
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("roles")
}

model UserRank {
  id              String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name            String   @map("name") @db.VarChar(50)
  minPoint        Int      @default(0) @map("min_point")
  discountPercent Float    @default(0) @map("discount_percent")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("user_ranks")
}

model User {
  id            String      @id @default(uuid()) @map("id") @db.VarChar(36)
  username      String      @unique @map("username") @db.VarChar(100)
  password      String      @map("password") @db.VarChar(255)
  fullName      String      @map("full_name") @db.VarChar(100)
  roleId        String      @map("role_id") @db.VarChar(36)
  rankId        String?     @map("rank_id") @db.VarChar(36)
  mongoUserId   String?     @map("mongo_user_id") @db.VarChar(36)
  currentPoints Int         @default(0) @map("current_points")
  status        UserStatus? @default(active) @map("status")
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt     DateTime    @default(now()) @map("updated_at") @db.Timestamp(0)

  @@index([roleId], map: "roleIdIdx")
  @@index([rankId], map: "rankIdIdx")
  @@map("users")
}

model Shift {
  id        String    @id @default(uuid()) @map("id") @db.VarChar(36)
  userId    String    @map("user_id") @db.VarChar(36)
  startTime DateTime  @default(now()) @map("start_time") @db.Timestamp(0)
  endTime   DateTime? @map("end_time") @db.Timestamp(0)
  cashStart Decimal   @map("cash_start") @db.Decimal(12, 2)
  cashEnd   Decimal?  @map("cash_end") @db.Decimal(12, 2)

  @@index([userId], map: "shiftUserIdIdx")
  @@map("shifts")
}

model PointHistory {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  userId    String   @map("user_id") @db.VarChar(36)
  amount    Int      @map("amount")
  reason    String   @map("reason") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([userId], map: "phUserIdIdx")
  @@map("point_histories")
}

// ==========================================
// 2. CATALOG (DANH MỤC & SẢN PHẨM)
// ==========================================

model Category {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name      String   @map("name") @db.VarChar(100)
  parentId  String?  @map("parent_id") @db.VarChar(36)

  @@index([parentId], map: "categoryParentIdIdx")
  @@map("categories")
}

model Printer {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name      String   @map("name") @db.VarChar(100)
  ipAddress String   @map("ip_address") @db.VarChar(50)

  @@map("printers")
}

model Product {
  id         String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name       String   @map("name") @db.VarChar(150)
  categoryId String   @map("category_id") @db.VarChar(36)
  printerId  String?  @map("printer_id") @db.VarChar(36)
  basePrice  Decimal  @map("base_price") @db.Decimal(12, 2)
  isCombo    Boolean? @default(false) @map("is_combo")
  isActive   Boolean? @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([categoryId], map: "prodCatIdx")
  @@map("products")
}

model Variant {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  productId String   @map("product_id") @db.VarChar(36)
  name      String   @map("name") @db.VarChar(100)
  priceDiff Decimal  @default(0) @map("price_diff") @db.Decimal(12, 2)

  @@index([productId], map: "varProdIdx")
  @@map("variants")
}

model OptionGroup {
  id            String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name          String   @map("name") @db.VarChar(100)
  isMultiSelect Boolean? @default(false) @map("is_multi_select")

  @@map("option_groups")
}

model OptionItem {
  id         String   @id @default(uuid()) @map("id") @db.VarChar(36)
  groupId    String   @map("group_id") @db.VarChar(36)
  name       String   @map("name") @db.VarChar(100)
  priceExtra Decimal  @default(0) @map("price_extra") @db.Decimal(12, 2)

  @@index([groupId], map: "optGrpIdx")
  @@map("option_items")
}

model ProductOptionConfig {
  productId     String @map("product_id") @db.VarChar(36)
  optionGroupId String @map("option_group_id") @db.VarChar(36)

  @@id([productId, optionGroupId])
  @@map("product_option_configs")
}

model ComboItem {
  comboId   String @map("combo_id") @db.VarChar(36)
  productId String @map("product_id") @db.VarChar(36)
  quantity  Int    @default(1) @map("quantity")

  @@id([comboId, productId])
  @@map("combo_items")
}

// ==========================================
// 3. INVENTORY (KHO & CÔNG THỨC)
// ==========================================

model Supplier {
  id      String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name    String   @map("name") @db.VarChar(150)
  contact String?  @map("contact") @db.VarChar(100)

  @@map("suppliers")
}

model Ingredient {
  id             String   @id @default(uuid()) @map("id") @db.VarChar(36)
  name           String   @map("name") @db.VarChar(150)
  baseUnit       String   @map("base_unit") @db.VarChar(20)
  minStock       Float    @default(0) @map("min_stock")
  forecastDataId String?  @map("forecast_data_id") @db.VarChar(36)

  @@map("ingredients")
}

model UnitConversion {
  id           String   @id @default(uuid()) @map("id") @db.VarChar(36)
  ingredientId String   @map("ingredient_id") @db.VarChar(36)
  fromUnit     String   @map("from_unit") @db.VarChar(20)
  toUnit       String   @map("to_unit") @db.VarChar(20)
  factor       Float    @map("factor")

  @@index([ingredientId], map: "ucIngIdx")
  @@map("unit_conversions")
}

model InventoryBatch {
  id           String   @id @default(uuid()) @map("id") @db.VarChar(36)
  ingredientId String   @map("ingredient_id") @db.VarChar(36)
  quantity     Float    @map("quantity")
  expiryDate   DateTime @map("expiry_date") @db.Timestamp(0)
  importDate   DateTime @default(now()) @map("import_date") @db.Timestamp(0)

  @@index([ingredientId], map: "batchIngIdx")
  @@map("inventory_batches")
}

model Recipe {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(36)
  ingredientId String  @map("ingredient_id") @db.VarChar(36)
  amount       Float   @map("amount")
  productId    String? @map("product_id") @db.VarChar(36)
  variantId    String? @map("variant_id") @db.VarChar(36)
  optionItemId String? @map("option_item_id") @db.VarChar(36)

  @@index([productId], map: "recProdIdx")
  @@index([variantId], map: "recVarIdx")
  @@index([ingredientId], map: "recIngIdx")
  @@map("recipes")
}

model ImportInvoice {
  id         String   @id @default(uuid()) @map("id") @db.VarChar(36)
  supplierId String   @map("supplier_id") @db.VarChar(36)
  totalCost  Decimal  @map("total_cost") @db.Decimal(12, 2)
  importDate DateTime @default(now()) @map("import_date") @db.Timestamp(0)

  @@index([supplierId], map: "invSupIdx")
  @@map("import_invoices")
}

model ImportInvoiceDetail {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(36)
  invoiceId    String  @map("invoice_id") @db.VarChar(36)
  ingredientId String  @map("ingredient_id") @db.VarChar(36)
  quantity     Float   @map("quantity")
  unit         String  @map("unit") @db.VarChar(20)
  unitPrice    Decimal @map("unit_price") @db.Decimal(12, 2)

  @@index([invoiceId], map: "invDetIdx")
  @@map("import_invoice_details")
}

model PurchaseProposal {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  creatorId String?  @map("creator_id") @db.VarChar(36)
  status    String   @default("PENDING") @map("status") @db.VarChar(20)
  note      String?  @map("note") @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@map("purchase_proposals")
}

model PurchaseProposalDetail {
  id           String @id @default(uuid()) @map("id") @db.VarChar(36)
  proposalId   String @map("proposal_id") @db.VarChar(36)
  ingredientId String @map("ingredient_id") @db.VarChar(36)
  quantity     Float  @map("quantity")
  unit         String @map("unit") @db.VarChar(20)

  @@index([proposalId], map: "ppDetailIdx")
  @@map("purchase_proposal_details")
}

model StockCheck {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  userId    String   @map("user_id") @db.VarChar(36)
  note      String?  @map("note") @db.Text
  checkDate DateTime @default(now()) @map("check_date") @db.Timestamp(0)

  @@map("stock_checks")
}

model StockCheckDetail {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(36)
  checkId      String  @map("check_id") @db.VarChar(36)
  ingredientId String  @map("ingredient_id") @db.VarChar(36)
  systemQty    Float   @map("system_qty")
  actualQty    Float   @map("actual_qty")
  reason       String? @map("reason") @db.VarChar(255)

  @@index([checkId], map: "stockDetIdx")
  @@map("stock_check_details")
}

// ==========================================
// 4. OPERATIONS (VẬN HÀNH & BÀN)
// ==========================================

model Zone {
  id   String @id @default(uuid()) @map("id") @db.VarChar(36)
  name String @map("name") @db.VarChar(50)

  @@map("zones")
}

model Table {
  id        String      @id @default(uuid()) @map("id") @db.VarChar(36)
  zoneId    String      @map("zone_id") @db.VarChar(36)
  name      String      @map("name") @db.VarChar(50)
  qrCode    String      @unique @map("qr_code") @db.VarChar(100)
  status    TableStatus @default(available) @map("status")

  @@index([zoneId], map: "tblZoneIdx")
  @@map("tables")
}

model Reservation {
  id           String   @id @default(uuid()) @map("id") @db.VarChar(36)
  userId       String?  @map("user_id") @db.VarChar(36)
  tableId      String   @map("table_id") @db.VarChar(36)
  customerName String   @map("customer_name") @db.VarChar(100)
  phone        String   @map("phone") @db.VarChar(20)
  time         DateTime @map("time") @db.Timestamp(0)
  status       String   @default("PENDING") @map("status") @db.VarChar(20)

  @@index([tableId], map: "resTblIdx")
  @@map("reservations")
}

// ==========================================
// 5. SALES (BÁN HÀNG & KHUYẾN MÃI)
// ==========================================

model Cart {
  id        String   @id @default(uuid()) @map("id") @db.VarChar(36)
  userId    String   @unique @map("user_id") @db.VarChar(36)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamp(0)

  @@map("carts")
}

model CartItem {
  id        String  @id @default(uuid()) @map("id") @db.VarChar(36)
  cartId    String  @map("cart_id") @db.VarChar(36)
  productId String  @map("product_id") @db.VarChar(36)
  quantity  Int     @default(1) @map("quantity")
  note      String? @map("note") @db.Text

  @@index([cartId], map: "cartItmIdx")
  @@map("cart_items")
}

model Voucher {
  id          String        @id @default(uuid()) @map("id") @db.VarChar(36)
  code        String        @unique @map("code") @db.VarChar(50)
  type        VoucherType   @default(fixed_amount) @map("type")
  value       Decimal       @map("value") @db.Decimal(12, 2)
  minOrderVal Decimal?      @default(0) @map("min_order_val") @db.Decimal(12, 2)
  usageLimit  Int?          @default(0) @map("usage_limit")
  isActive    Boolean       @default(true) @map("is_active")
  startDate   DateTime      @map("start_date") @db.Timestamp(0)
  endDate     DateTime      @map("end_date") @db.Timestamp(0)

  @@map("vouchers")
}

model Order {
  id          String      @id @default(uuid()) @map("id") @db.VarChar(36)
  userId      String?     @map("user_id") @db.VarChar(36)
  totalAmount Decimal     @map("total_amount") @db.Decimal(12, 2)
  status      OrderStatus @default(pending) @map("status")
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([userId], map: "ordUserIdx")
  @@map("orders")
}

model OrderVoucher {
  orderId   String @map("order_id") @db.VarChar(36)
  voucherId String @map("voucher_id") @db.VarChar(36)

  @@id([orderId, voucherId])
  @@map("order_vouchers")
}

model OrderTable {
  orderId String @map("order_id") @db.VarChar(36)
  tableId String @map("table_id") @db.VarChar(36)

  @@id([orderId, tableId])
  @@map("order_tables")
}

model OrderItem {
  id          String  @id @default(uuid()) @map("id") @db.VarChar(36)
  orderId     String  @map("order_id") @db.VarChar(36)
  productId   String  @map("product_id") @db.VarChar(36)
  variantId   String? @map("variant_id") @db.VarChar(36)
  productName String  @map("product_name") @db.VarChar(150)
  price       Decimal @map("price") @db.Decimal(12, 2)
  quantity    Int     @map("quantity")

  @@index([orderId], map: "oiOrdIdx")
  @@map("order_items")
}

model OrderItemOption {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(36)
  orderItemId  String  @map("order_item_id") @db.VarChar(36)
  optionItemId String  @map("option_item_id") @db.VarChar(36)
  optionName   String  @map("option_name") @db.VarChar(100)
  price        Decimal @map("price") @db.Decimal(12, 2)

  @@index([orderItemId], map: "oioItemIdx")
  @@map("order_item_options")
}

model PaymentTransaction {
  id        String        @id @default(uuid()) @map("id") @db.VarChar(36)
  orderId   String        @map("order_id") @db.VarChar(36)
  amount    Decimal       @map("amount") @db.Decimal(12, 2)
  method    PaymentMethod @default(cash) @map("method")
  status    PaymentStatus @default(pending) @map("status")
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([orderId], map: "payOrdIdx")
  @@map("payment_transactions")
}

model Invoice {
  id       String   @id @default(uuid()) @map("id") @db.VarChar(36)
  orderId  String   @unique @map("order_id") @db.VarChar(36)
  taxCode  String?  @map("tax_code") @db.VarChar(50)
  issuedAt DateTime @default(now()) @map("issued_at") @db.Timestamp(0)

  @@map("invoices")
}

enum UserStatus {
  active
  inactive
  banned
}

enum TableStatus {
  available
  occupied
  reserved
  maintenance
}

enum OrderStatus {
  pending
  confirmed
  processing
  served
  completed
  cancelled
}

enum PaymentMethod {
  cash
  credit_card
  bank_transfer
  wallet
}

enum PaymentStatus {
  pending
  success
  failed
}

enum VoucherType {
  percentage
  fixed_amount
}